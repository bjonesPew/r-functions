###############################Mode effect functions
###Runs regressions to control for sample composition between modes
###Appends predicted values from regressions to phone and web datasets
runModeRegressions <- function(controls, pdat, wdat) {
	##Set up the equation
	eqn <- paste("y ~", paste(controls, collapse = "+"))

	##run the phone model
	pmod <- glm(eqn, data = pdat, family = binomial)

	##run the web model
	wmod <- glm(eqn, data = wdat, family = binomial)

	##append predictions to phone dataset
	pdat$phonepred <- predict(pmod, newdata = pdat,
		type = 'response')
	pdat$webpred <- predict(wmod, newdata = pdat,
		type = 'response')

	##append predictions to web dataset
	wdat$phonepred <- predict(pmod, newdata = wdat,
		type = 'response')
	wdat$webpred <- predict(wmod, newdata = wdat,
		type = 'response')

	return(list(pdat, wdat))

}

###add replicate weights
rep_weights <- function(wgt, n.rep = 200) {
	rweights <- array(0, c(length(wgt), n.rep))
	
	for (j in 1:n.rep) {
		s <- sample(1:length(wgt), size = length(wgt),
			replace = TRUE)
		tab <- table(s)
		rweights[as.numeric(names(tab)),j] <- tab
		rweights[,j] <- rweights[,j]*wgt
	}
	return(rweights)
}

###Function to show the overall mode difference and the 
###sample composition adjustment
###Single punch

testModeOverall <- function(controls, pdat, wdat, N.rep = 200) {

	regRes <- runModeRegressions(controls, pdat, wdat)
	pdat = regRes[[1]]
	wdat = regRes[[2]]


	##############Show the mode effect on total
	##containers to hold the results
	mode <- reg <- adj <- rep(NA, N.rep)

	winds <- which(!is.na(wdat$y))
	pinds <- which(!is.na(pdat$y))
	for (k in 1:N.rep) {
		##Draw new samples from the phone and web data
		s1 <- sample(winds, p = wdat$weight[winds],
			size = length(winds), replace = TRUE)

		s2 <- sample(pinds, p = pdat$weight[pinds],
			size = length(pinds), replace = TRUE)

		##Run out the means with the resampled data
		wt <- mean(wdat$y[s1])
		pt <- mean(pdat$y[s2])

		##get the web - phone difference
		mode[k] <- wt - pt

		##Run out the means of the adjusted resampled data
		ag1 <- mean(wdat$phonepred[s1])
		ag2 <- mean(wdat$webpred[s1])

		##store the results
		reg[k] <- ag2 - ag1

	}

	##Open a new graphics window
	dev.new()
	par(mfrow = c(1,2))
	ylim = range( c(mode, mode - reg) )

	##plot the variance of the mode difference
	boxplot(mode, ylim = ylim,
		main = "Web - Phone diff")
	abline(h = 0)
	##plot the regression adjusted difference
	boxplot(mode - reg, ylim = ylim,
		main = "Sample composition\nadjustment")
	abline(h = 0)

}


###Function to show the overall mode difference and the 
###sample composition adjustment
###Full distribution

testModeOverallFull <- function(controls, pdat, wdat, N.rep = 200,
	pname, wname, descrip = NULL) {

	ptab <- table(pdat[[pname]])
	wtab <- table(wdat[[wname]])
	
	if (length(ptab) != length(wtab)) {
		vol <- grep("vol", names(ptab), ignore.case = TRUE)
		vals <- 1:length(ptab)
		vals[vol] <- 99
		pdat[[pname]] <- factor(recode(pdat[[pname]], vals))
		ptab <- table(pdat[[pname]])
		if (length(ptab) != length(wtab)) return("Error")
	}
	
	lev <- names(wtab)
	
	##containers to hold the results
	mode <- reg <- adj <- array(NA, c(N.rep, length(lev)))
	colnames(mode) <- colnames(adj) <- lev
	
	for (L in 1:length(lev)) {

		pdat$y <- pdat[[pname]] == levels(pdat[[pname]])[L]
		wdat$y <- wdat[[wname]] == levels(wdat[[wname]])[L]

		regRes <- runModeRegressions(controls, pdat, wdat)
		pdat = regRes[[1]]
		wdat = regRes[[2]]
	
	

		winds <- which(!is.na(wdat$y))
		pinds <- which(!is.na(pdat$y))
		for (k in 1:N.rep) {
			##Draw new samples from the phone and web data
			s1 <- sample(winds, #p = wdat$weight[winds],
				size = length(winds), replace = TRUE)

			s2 <- sample(pinds, p = pdat$weight[pinds],
				size = length(pinds), replace = TRUE)
	
			##Run out the means with the resampled data ###ADD WEIGHTED MEANS
			wt <- wmean(wdat$webpred[s1], wdat$weight[s1])
			pt <- wmean(pdat$phonepred[s2], wdat$weight[s1])
	
			##get the web - phone difference
			mode[k,L] <- wt - pt

			##Run out the means of the adjusted resampled data
			delta <- wdat$phonepred[s1] - wdat$webpred[s1]

			##store the results
			reg[k,L] <- wmean(delta, wdat$weight[s1])

		}
	}

	##Open a new graphics window
	dev.new()
	par(mfrow = c(1,2))
	ylim = range( c(mode, mode - reg) )

	##plot the variance of the mode difference
	boxplot(mode, ylim = ylim,
		main = "Web - Phone diff")
	abline(h = 0)
	##plot the regression adjusted difference
	boxplot(mode - reg, ylim = ylim,
		main = "Sample composition\nadjustment")
	abline(h = 0)
	
	if (!is.null(descrip)) text( length(lev)/2, ylim[2], descrip )

}


###test for mode effects among subgroups
testModeSubgroups <- function(controls, pdat, wdat, N.rep = 200,
	x.cats = NULL) {

	regRes <- runModeRegressions(controls, pdat, wdat)
	pdat = regRes[[1]]
	wdat = regRes[[2]]


	##############Show the mode effect on total
	##containers to hold the results
	if (is.null(x.cats)) x.cats <- length(table(wdat$x))
	mode <- reg <- adj <- array(NA, c(N.rep, x.cats))

	winds <- which(!is.na(wdat$y))
	pinds <- which(!is.na(pdat$y))

	colnames(mode) <- colnames(adj) <- names(table(wdat$x))[1:x.cats]
	for (k in 1:N.rep) {
		##Draw new samples from the phone and web data
		s1 <- sample(winds, p = wdat$weight[winds],
			size = length(winds), replace = TRUE)

		s2 <- sample(pinds, p = pdat$weight[pinds],
			size = length(pinds), replace = TRUE)

		##Run out the means with the resampled data
		wt <- aggregate(y ~ x, data = wdat[s1,], FUN = mean)
		pt <- aggregate(y ~ x, data = pdat[s2,], FUN = mean)

		##get the web - phone difference
		mode[k,] <- wt[1:x.cats,2] - pt[1:x.cats,2]

		##Run out the means of the adjusted resampled data
		ag1 <- aggregate(phonepred ~ x, data = wdat[s1,], FUN = mean)
		ag2 <- aggregate(webpred ~ x, data = wdat[s1,], FUN = mean)


		##store the results
		reg[k,] <- ag2[1:x.cats,2] - ag1[1:x.cats,2]

	}

	##Open a new graphics window
	dev.new()
	par(mfrow = c(1,2))
	ylim = range( c(mode, mode - reg) )

	##plot the variance of the mode difference
	boxplot(mode, ylim = ylim,
		main = "Web - Phone diff")
	abline(h = 0)
	##plot the regression adjusted difference
	boxplot(mode - reg, ylim = ylim,
		main = "Sample composition\nadjustment")
	abline(h = 0)

}
